<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Workout in Progress</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* override timer colour to pulse gently */
        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 8px rgba(232,69,69,.4); }
            50%      { text-shadow: 0 0 18px rgba(232,69,69,.7); }
        }
        .timer { animation: pulse-glow 2s ease-in-out infinite; }

        /* sticky end-workout bar at bottom on mobile */
        .end-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: .75rem 1.5rem;
            display: flex;
            justify-content: center;
            z-index: 100;
        }

        /* input number ‚Äî hide spinners */
        .input[type=number]::-webkit-inner-spin-button,
        .input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; }
        .input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>

<nav class="nav">
    <span class="nav__logo">‚ö° Workout Logger</span>
    <div class="nav__links">
        <a href="/">Home</a>
        <a href="/templates">Templates</a>
        <a href="/workout-history">History</a>
    </div>
</nav>

<!-- hidden session id for JS -->
<input type="hidden" id="sessionId" th:value="${sessionId}">

<div class="page" style="padding-bottom:5rem;">  <!-- extra bottom pad for sticky bar -->

    <!-- Timer -->
    <div style="text-align:center; margin-bottom:1.5rem;">
        <div class="timer" id="workoutTimer">00:00:00</div>
        <div class="timer timer--small" id="restTimer" style="display:none;">Rest: 00:00</div>
    </div>

    <!-- live summary (updated by poller) -->
    <div id="summary" style="margin-bottom:1.5rem;"></div>

    <!-- Exercise set blocks (server-rendered) -->
    <div th:each="exerciseGroup : ${setsByExercise}" class="set-block">
        <div class="set-block__header">
            <span th:text="${exerciseGroup.key}">Exercise Name</span>
        </div>

        <div class="card" style="padding:0;">
            <!-- existing sets -->
            <div th:each="set : ${exerciseGroup.value}" class="set-row" style="padding:.6rem .85rem;">
                <form th:action="@{/workout-sessions/{id}/sets/{setId}(id=${sessionId}, setId=${set.id})}"
                      method="post"
                      style="display:flex; align-items:center; gap:.6rem; width:100%;">

                    <label style="width:28px; font-size:.78rem; color:var(--text-dim); font-weight:600; margin:0;">Set</label>

                    <div style="flex:1; display:flex; gap:.5rem; align-items:center;">
                        <div style="flex:1;">
                            <label style="font-size:.7rem; margin-bottom:.15rem;">Reps</label>
                            <input type="number" name="reps" th:value="${set.reps}" class="input" style="width:100%; text-align:center;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:.7rem; margin-bottom:.15rem;">Weight</label>
                            <input type="number" name="weight" th:value="${set.weight}" class="input" style="width:100%; text-align:center;">
                        </div>
                    </div>

                    <button type="submit" class="btn btn--secondary" style="padding:.5rem .75rem; flex-shrink:0;">Save</button>
                </form>
            </div>

            <!-- add set row -->
            <div style="padding:.5rem .85rem; border-top:1px solid var(--border);">
                <form th:action="@{/workout-sessions/{id}/sets/add-new(id=${sessionId})}"
                      method="post">
                    <input type="hidden" name="exerciseName" th:value="${exerciseGroup.key}">
                    <button type="submit" class="btn btn--ghost btn--block" style="padding:.45rem;">+ Add Set</button>
                </form>
            </div>
        </div>
    </div>

    <!-- empty state if no exercises -->
    <div th:if="${setsByExercise.isEmpty()}" class="empty">
        <div class="empty__icon">üèãÔ∏è</div>
        <p>No exercises loaded. This is an ad-hoc workout ‚Äî sets will appear here as you add them via the API.</p>
    </div>

</div>

<!-- sticky End Workout bar -->
<div class="end-bar">
    <button class="btn btn--danger" onclick="endWorkout()" style="font-size:1rem; padding:.7rem 2rem;">‚èπ End Workout</button>
</div>

<!-- ============================================================
     ALL EXISTING JS ‚Äî untouched logic, same functions & contract
     ============================================================ -->
<script th:inline="javascript">
/* ===============================
   Server-injected values
   =============================== */

const sessionId = document.getElementById("sessionId")?.value;
const workoutStartTime = new Date([[${startTimeMillis}]]);

if (!sessionId) {
    console.error("Session ID not found in DOM");
}

if (isNaN(workoutStartTime.getTime())) {
    console.error("Invalid workoutStartTime injected from server");
}

/* ===============================
   Utility
   =============================== */

function pad(n) {
    return n.toString().padStart(2, "0");
}

/* ===============================
   TOTAL WORKOUT TIMER
   =============================== */

let workoutTimerInterval = null;

function updateWorkoutTimer() {
    const timerEl = document.getElementById("workoutTimer");
    if (!timerEl) return;

    const elapsedMs = Date.now() - workoutStartTime.getTime();
    if (isNaN(elapsedMs)) return;

    const totalSeconds = Math.floor(elapsedMs / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    timerEl.innerText = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
}

function startWorkoutTimer() {
    if (workoutTimerInterval) return;
    updateWorkoutTimer();
    workoutTimerInterval = setInterval(updateWorkoutTimer, 1000);
}

/* ===============================
   REST TIMER
   =============================== */

let restSeconds = 0;
let restInterval = null;

function startRestTimer() {
    stopRestTimer();
    restSeconds = 0;
    document.getElementById("restTimer").style.display = "block";

    restInterval = setInterval(() => {
        const restEl = document.getElementById("restTimer");
        if (!restEl) return;

        restSeconds++;
        const minutes = Math.floor(restSeconds / 60);
        const seconds = restSeconds % 60;

        restEl.innerText = `Rest: ${pad(minutes)}:${pad(seconds)}`;
    }, 1000);
}

function stopRestTimer() {
    if (restInterval) {
        clearInterval(restInterval);
        restInterval = null;
    }
}

/* ===============================
   API CALLS
   =============================== */

let summaryPoller = null;

function addSet() {
    const exerciseName = document.getElementById("exerciseName")?.value;
    const reps = parseInt(document.getElementById("reps")?.value, 10);
    const weight = parseFloat(document.getElementById("weight")?.value);

    if (!exerciseName) return;

    fetch(`/api/workout-sessions/${sessionId}/sets`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ exerciseName, reps, weight })
    }).then(() => {
        startRestTimer();
        loadSummary();
    });
}

function loadSummary() {
    fetch(`/api/workout-sessions/${sessionId}/summary`)
        .then(response => {
            if (response.status === 404) {
                alert("This workout session no longer exists.");
                if (summaryPoller) clearInterval(summaryPoller);
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data) renderSummary(data);
        });
}

function renderSummary(summary) {
    const summaryEl = document.getElementById("summary");
    if (!summaryEl) return;

    // Build a nice live stats bar
    let html = `<div class="stats">
        <div class="stat">
            <div class="stat__label">Sets</div>
            <div class="stat__value">${summary.totalSets}</div>
        </div>
        <div class="stat">
            <div class="stat__label">Volume</div>
            <div class="stat__value">${summary.totalVolume.toLocaleString()}</div>
            <div class="stat__unit">lbs</div>
        </div>`;

    if (summary.exercises && summary.exercises.length > 0) {
        html += `<div class="stat">
            <div class="stat__label">Exercises</div>
            <div class="stat__value">${summary.exercises.length}</div>
        </div>`;
    }

    html += '</div>';
    summaryEl.innerHTML = html;
}

/* ===============================
   END WORKOUT
   =============================== */

function endWorkout() {
    if (!confirm("End this workout?")) return;

    fetch(`/api/workout-sessions/${sessionId}/end`, {
        method: "PUT"
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Failed to end workout");
        }

        if (workoutTimerInterval) clearInterval(workoutTimerInterval);
        if (restInterval) clearInterval(restInterval);
        if (summaryPoller) clearInterval(summaryPoller);

        window.location.href = `/workout-sessions/${sessionId}/summary`;
    })
    .catch(err => {
        console.error(err);
        alert("Could not end workout.");
    });
}

/* ===============================
   START EVERYTHING
   =============================== */

startWorkoutTimer();
loadSummary();
summaryPoller = setInterval(loadSummary, 3000);
</script>

</body>
</html>
