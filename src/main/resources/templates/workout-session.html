<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Workout Logger</title>
</head>
<body>

<h2 id="workoutTimer">00:00:00</h2>
<h1>Workout Logger</h1>

<input type="hidden" id="sessionId" th:value="${sessionId}">

<h2>Add Sets</h2>

<div th:each="exerciseGroup : ${setsByExercise}">
    <h3 th:text="${exerciseGroup.key}">Exercise Name</h3>

    <table>
        <thead>
        <tr>
            <th>Reps</th>
            <th>Weight</th>
            <th>Save</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="set : ${exerciseGroup.value}">
            <td colspan="3">
                <form th:action="@{/workout-sessions/{id}/sets/{setId}(id=${sessionId}, setId=${set.id})}"
                      method="post"
                      style="display:flex; gap:12px">

                    <input type="number" name="reps" th:value="${set.reps}">
                    <input type="number" name="weight" th:value="${set.weight}">
                    <button type="submit">Save</button>

                </form>
            </td>
        </tr>

        <tr>
            <td colspan="3">
                <form th:action="@{/workout-sessions/{id}/sets/add-new(id=${sessionId})}"
                      method="post">
                    <input type="hidden" name="exerciseName"
                           th:value="${exerciseGroup.key}">
                    <button type="submit">+ Add Set</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>




<script th:inline="javascript">
/* ===============================
   Server-injected values
   =============================== */

const sessionId = document.getElementById("sessionId")?.value;
const workoutStartTime = new Date([[${startTimeMillis}]]);

if (!sessionId) {
    console.error("Session ID not found in DOM");
}

if (isNaN(workoutStartTime.getTime())) {
    console.error("Invalid workoutStartTime injected from server");
}

/* ===============================
   Utility
   =============================== */

function pad(n) {
    return n.toString().padStart(2, "0");
}

/* ===============================
   TOTAL WORKOUT TIMER
   =============================== */

let workoutTimerInterval = null;

function updateWorkoutTimer() {
    const timerEl = document.getElementById("workoutTimer");
    if (!timerEl) return;

    const elapsedMs = Date.now() - workoutStartTime.getTime();
    if (isNaN(elapsedMs)) return;

    const totalSeconds = Math.floor(elapsedMs / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    timerEl.innerText = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
}

function startWorkoutTimer() {
    if (workoutTimerInterval) return;
    updateWorkoutTimer();
    workoutTimerInterval = setInterval(updateWorkoutTimer, 1000);
}

/* ===============================
   REST TIMER
   =============================== */

let restSeconds = 0;
let restInterval = null;

function startRestTimer() {
    stopRestTimer();
    restSeconds = 0;

    restInterval = setInterval(() => {
        const restEl = document.getElementById("restTimer");
        if (!restEl) return;

        restSeconds++;
        const minutes = Math.floor(restSeconds / 60);
        const seconds = restSeconds % 60;

        restEl.innerText = `${pad(minutes)}:${pad(seconds)}`;
    }, 1000);
}

function stopRestTimer() {
    if (restInterval) {
        clearInterval(restInterval);
        restInterval = null;
    }
}

/* ===============================
   API CALLS
   =============================== */

let summaryPoller = null;

function addSet() {
    const exerciseName = document.getElementById("exerciseName")?.value;
    const reps = parseInt(document.getElementById("reps")?.value, 10);
    const weight = parseFloat(document.getElementById("weight")?.value);

    if (!exerciseName) return;

    fetch(`/api/workout-sessions/${sessionId}/sets`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ exerciseName, reps, weight })
    }).then(() => {
        startRestTimer();
        loadSummary();
    });
}

function loadSummary() {
    fetch(`/api/workout-sessions/${sessionId}/summary`)
        .then(response => {
            if (response.status === 404) {
                alert("This workout session no longer exists.");
                if (summaryPoller) clearInterval(summaryPoller);
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data) renderSummary(data);
        });
}

function renderSummary(summary) {
    const summaryEl = document.getElementById("summary");
    if (!summaryEl) return;

    let html = `
        <p>Status: ${summary.status}</p>
        <p>Total Sets: ${summary.totalSets}</p>
        <p>Total Volume: ${summary.totalVolume}</p>
        <ul>
    `;

    for (const ex of summary.exercises) {
        html += `<li>${ex.name}: ${ex.sets} sets, volume ${ex.volume}</li>`;
    }

    html += "</ul>";
    summaryEl.innerHTML = html;
}

/* ===============================
   END WORKOUT
   =============================== */

function endWorkout() {
    if (!confirm("End this workout?")) return;

    fetch(`/api/workout-sessions/${sessionId}/end`, {
        method: "PUT"
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Failed to end workout");
        }

        if (workoutTimerInterval) clearInterval(workoutTimerInterval);
        if (restInterval) clearInterval(restInterval);
        if (summaryPoller) clearInterval(summaryPoller);

        window.location.href = `/workout-sessions/${sessionId}/summary`;
    })
    .catch(err => {
        console.error(err);
        alert("Could not end workout.");
    });
}

/* ===============================
   START EVERYTHING
   =============================== */

startWorkoutTimer();
loadSummary();
summaryPoller = setInterval(loadSummary, 3000);

</script>



<button onclick="endWorkout()">End Workout</button>

</body>
</html>
