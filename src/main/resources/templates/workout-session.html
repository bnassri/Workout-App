<!DOCTYPE html>
<<html xmlns:th="http://www.thymeleaf.org">>
<head>
    <meta charset="UTF-8">
    <title>Live Workout</title>
</head>
<body>

<h1>Live Workout Session</h1>

<!-- Store session ID in the page -->
<input type="hidden" id="sessionId" th:value="${sessionId}" />
<h2>Workout Timers</h2>

<div>
    <strong>Total Workout Time:</strong>
    <span id="workoutTimer">00:00:00</span>
</div>

<div>
    <strong>Rest Timer:</strong>
    <span id="restTimer">00:00</span>
</div>


<h2>Add Set</h2>

<label>
    Exercise:
    <input id="exerciseName" type="text" />
</label>
<br/>

<label>
    Reps:
    <input id="reps" type="number" />
</label>
<br/>

<label>
    Weight:
    <input id="weight" type="number" />
</label>
<br/>

<button onclick="addSet()">Add Set</button>

<hr/>

<h2>Session Summary</h2>

<div id="summary">
    Loading...
</div>

<script th:inline="javascript">
    const sessionId = document.getElementById("sessionId").value;

    /**
     * POST a new set to the backend
     */
    function addSet() {
        const exerciseName = document.getElementById("exerciseName").value;
        const reps = parseInt(document.getElementById("reps").value);
        const weight = parseFloat(document.getElementById("weight").value);

        fetch(`/api/workout-sessions/${sessionId}/sets`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                exerciseName,
                reps,
                weight
            })
        }).then(() => {
            // Refresh summary and timer immediately after adding a set
            startRestTimer();
            loadSummary();
        });
    }

    /**
     * Fetch live session summary
     */
    function loadSummary() {
        fetch(`/api/workout-sessions/${sessionId}/summary`)
            .then(response => response.json())
            .then(data => {
                renderSummary(data);
            });
    }

    /**
     * Render summary data into HTML
     */
    function renderSummary(summary) {
        let html = `
            <p>Status: ${summary.status}</p>
            <p>Total Sets: ${summary.totalSets}</p>
            <p>Total Volume: ${summary.totalVolume}</p>
            <ul>
        `;

        for (const ex of summary.exercises) {
            html += `<li>${ex.name}: ${ex.sets} sets, volume ${ex.volume}</li>`;
        }

        html += "</ul>";

        document.getElementById("summary").innerHTML = html;
    }

    // Poll every 3 seconds
    setInterval(loadSummary, 3000);

    // Initial load
    loadSummary();


    // --- TOTAL WORKOUT TIMER ---

    // Session start time injected by Thymeleaf
const workoutStartTime = new Date('[[${session.startTime}]]');

    function pad(number) {
        return number.toString().padStart(2, "0");
    }

    function updateWorkoutTimer() {
        const now = new Date();
        const elapsedMs = now - workoutStartTime;

        const totalSeconds = Math.floor(elapsedMs / 1000);

        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const timerEl = document.getElementById("workoutTimer");
        if (!timerEl) return; // DOM not ready yet

        timerEl.innerText = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }

    document.addEventListener("DOMContentLoaded", () => {
        updateWorkoutTimer();
        setInterval(updateWorkoutTimer, 1000);
    });

   // --- REST TIMER ---

    let restSeconds = 0;
    let restInterval = null;

    function startRestTimer() {
        stopRestTimer();
        restSeconds = 0;

        restInterval = setInterval(() => {
            restSeconds++;
            updateRestTimerDisplay();
        }, 1000);
    }

    function stopRestTimer() {
        if (restInterval) {
            clearInterval(restInterval);
            restInterval = null;
        }
    }

    function updateRestTimerDisplay() {
        const minutes = Math.floor(restSeconds / 60);
        const seconds = restSeconds % 60;

        document.getElementById("restTimer").innerText =
            `${pad(minutes)}:${pad(seconds)}`;
    }


</script>

</body>
</html>
