<!DOCTYPE html>
<<html xmlns:th="http://www.thymeleaf.org">>
<head>
    <meta charset="UTF-8">
    <title>Workout Logger</title>
</head>
<body>

<h1>Workout Logger</h1>

<!-- Store session ID in the page -->
<input type="hidden" id="sessionId" th:value="${sessionId}" >
<h2>Workout Timers</h2>


<!-- DEBUG: remove later -->
<p th:text="'Session ID: ' + ${session.id}"></p>

<div>
    <strong>Total Workout Time:</strong>
    <span id="workoutTimer">00:00:00</span>
</div>

<div>
    <strong>Rest Timer:</strong>
    <span id="restTimer">00:00</span>
</div>


<h2>Add Sets</h2>

<div th:each="exerciseGroup : ${setsByExercise}">
    <h3 th:text="${exerciseGroup.key}">Exercise Name</h3>

    <table>
        <tr>
            <th>Reps</th>
            <th>Weight</th>
            <th>Save</th>
        </tr>

        <tr th:each="set : ${exerciseGroup.value}">
            <form th:action="@{/workout-sessions/{id}/sets/{setId}(id=${session.id}, setId=${set.id})}"
                  method="post">
                <td>
                    <input type="number" name="reps" th:value="${set.reps}">
                </td>
                <td>
                    <input type="number" name="weight" th:value="${set.weight}">
                </td>
                <td>
                    <button type="submit">Save</button>
                </td>
            </form>
        </tr>

        <tr>
            <td colspan="3">
                <form th:if="${session.id != null}"
                      th:action="@{/workout-sessions/{id}/sets/add(id=${session.id})}"
                      method="post">
                    <input type="hidden" name="exerciseName"
                           th:value="${exerciseGroup.key}">
                    <button type="submit">+ Add Set</button>
                </form>
            </td>
        </tr>
    </table>
</div>




<h2>Session Summary</h2>

<div id="summary">
    Loading...
</div>

<script th:inline="javascript">
/* ===============================
   Server-injected values
   =============================== */

const sessionId = document.getElementById("sessionId").value;
const workoutStartTime = new Date([[${startTimeMillis}]]);

if (isNaN(workoutStartTime.getTime())) {
    console.error("Invalid workoutStartTime injected from server");
}

/* ===============================
   Utility
   =============================== */

function pad(n) {
    return n.toString().padStart(2, "0");
}

/* ===============================
   TOTAL WORKOUT TIMER
   =============================== */

function updateWorkoutTimer() {
    const elapsedMs = new Date() - workoutStartTime;

    if (isNaN(elapsedMs)) return;

    const totalSeconds = Math.floor(elapsedMs / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    document.getElementById("workoutTimer").innerText =
        `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
}

/* ===============================
   REST TIMER
   =============================== */

let restSeconds = 0;
let restInterval = null;

function startRestTimer() {
    stopRestTimer();
    restSeconds = 0;

    restInterval = setInterval(() => {
        restSeconds++;
        const minutes = Math.floor(restSeconds / 60);
        const seconds = restSeconds % 60;

        document.getElementById("restTimer").innerText =
            `${pad(minutes)}:${pad(seconds)}`;
    }, 1000);
}

function stopRestTimer() {
    if (restInterval) {
        clearInterval(restInterval);
        restInterval = null;
    }
}

/* ===============================
   API CALLS
   =============================== */

let summaryPoller = null;

function addSet() {
    const exerciseName = document.getElementById("exerciseName").value;
    const reps = parseInt(document.getElementById("reps").value, 10);
    const weight = parseFloat(document.getElementById("weight").value);

    fetch(`/api/workout-sessions/${sessionId}/sets`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ exerciseName, reps, weight })
    }).then(() => {
        startRestTimer();
        loadSummary();
    });
}

function loadSummary() {
    fetch(`/api/workout-sessions/${sessionId}/summary`)
        .then(response => {
            if (response.status === 404) {
                alert("This workout session no longer exists.");
                clearInterval(summaryPoller);
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data) renderSummary(data);
        });
}

function renderSummary(summary) {
    let html = `
        <p>Status: ${summary.status}</p>
        <p>Total Sets: ${summary.totalSets}</p>
        <p>Total Volume: ${summary.totalVolume}</p>
        <ul>
    `;

    for (const ex of summary.exercises) {
        html += `<li>${ex.name}: ${ex.sets} sets, volume ${ex.volume}</li>`;
    }

    html += "</ul>";
    document.getElementById("summary").innerHTML = html;
}

/* ===============================
   END WORKOUT
   =============================== */

function endWorkout() {
    if (!confirm("End this workout?")) return;

    fetch(`/api/workout-sessions/${sessionId}/end`, {
        method: "PUT"
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Failed to end workout");
        }

        clearInterval(workoutTimerInterval);
        if (restInterval) clearInterval(restInterval);

        window.location.href = `/workout-sessions/${sessionId}/summary`;
    })
    .catch(err => {
        console.error(err);
        alert("Could not end workout.");
    });
}

/* ===============================
   START EVERYTHING
   =============================== */

updateWorkoutTimer();
const workoutTimerInterval = setInterval(updateWorkoutTimer, 1000);

loadSummary();
summaryPoller = setInterval(loadSummary, 3000);

</script>


<button onclick="endWorkout()">End Workout</button>

</body>
</html>
