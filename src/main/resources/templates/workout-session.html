<!DOCTYPE html>
<<html xmlns:th="http://www.thymeleaf.org">>
<head>
    <meta charset="UTF-8">
    <title>Live Workout</title>
</head>
<body>

<h1>Live Workout Session</h1>

<!-- Store session ID in the page -->
<input type="hidden" id="sessionId" th:value="${sessionId}" />
<h2>Workout Timers</h2>

<div>
    <strong>Total Workout Time:</strong>
    <span id="workoutTimer">00:00:00</span>
</div>

<div>
    <strong>Rest Timer:</strong>
    <span id="restTimer">00:00</span>
</div>


<h2>Add Set</h2>

<label>
    Exercise:
    <input id="exerciseName" type="text" />
</label>
<br/>

<label>
    Reps:
    <input id="reps" type="number" />
</label>
<br/>

<label>
    Weight:
    <input id="weight" type="number" />
</label>
<br/>

<button onclick="addSet()">Add Set</button>

<hr/>

<h2>Session Summary</h2>

<div id="summary">
    Loading...
</div>

<script th:inline="javascript">

    /* ===============================
       Server-injected values
       =============================== */

    const workoutStartTime = new Date('[[${session.startTime}]]');

    /* ===============================
       Utility
       =============================== */

    function pad(number) {
        return number.toString().padStart(2, "0");
    }

    /* ===============================
       TOTAL WORKOUT TIMER
       =============================== */

    function updateWorkoutTimer() {
        const now = new Date();
        const elapsedMs = now - workoutStartTime;

        if (isNaN(elapsedMs)) {
            console.error("Elapsed time is NaN", {
                now,
                workoutStartTime
            });
            return;
        }

        const totalSeconds = Math.floor(elapsedMs / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        document.getElementById("workoutTimer").innerText =
            `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }

    /* ===============================
       REST TIMER
       =============================== */

    let restSeconds = 0;
    let restInterval = null;

    function startRestTimer() {
        stopRestTimer();
        restSeconds = 0;

        restInterval = setInterval(() => {
            restSeconds++;
            const minutes = Math.floor(restSeconds / 60);
            const seconds = restSeconds % 60;

            document.getElementById("restTimer").innerText =
                `${pad(minutes)}:${pad(seconds)}`;
        }, 1000);
    }

    function stopRestTimer() {
        if (restInterval) {
            clearInterval(restInterval);
            restInterval = null;
        }
    }

    /* ===============================
       API CALLS
       =============================== */

    let sessionId;

    function addSet() {
        const exerciseName = document.getElementById("exerciseName").value;
        const reps = parseInt(document.getElementById("reps").value);
        const weight = parseFloat(document.getElementById("weight").value);

        fetch(`/api/workout-sessions/${sessionId}/sets`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ exerciseName, reps, weight })
        }).then(() => {
            startRestTimer();
            loadSummary();
        });
    }

    function loadSummary() {
        fetch(`/api/workout-sessions/${sessionId}/summary`)
            .then(r => r.json())
            .then(renderSummary);
    }

    function renderSummary(summary) {
        let html = `
            <p>Status: ${summary.status}</p>
            <p>Total Sets: ${summary.totalSets}</p>
            <p>Total Volume: ${summary.totalVolume}</p>
            <ul>
        `;

        for (const ex of summary.exercises) {
            html += `<li>${ex.name}: ${ex.sets} sets, volume ${ex.volume}</li>`;
        }

        html += "</ul>";
        document.getElementById("summary").innerHTML = html;
    }

    /* ===============================
       INIT (DOM READY)
       =============================== */

    document.addEventListener("DOMContentLoaded", () => {
        sessionId = document.getElementById("sessionId").value;

        // Timers
        updateWorkoutTimer();
        setInterval(updateWorkoutTimer, 1000);

        // Summary polling
        loadSummary();
        setInterval(loadSummary, 3000);
    });

</script>


</body>
</html>
